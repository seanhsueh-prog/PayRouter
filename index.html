<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CashFlow Sense</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#FAFAF9"> <!-- Stone-50 warm white -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <!-- 外部資源：React, Tailwind, FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind 設定：莫蘭迪色系 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // 背景基底：暖石灰/米白
                        base: { 50: '#FAFAF9', 100: '#F5F5F4', 200: '#E7E5E4', 300: '#D6D3D1', 800: '#57534E', 900: '#44403C' },
                        // 現金：鼠尾草綠 (Sage)
                        cash: { 100: '#DCFCE7', 500: '#84A98C', 600: '#52796F' }, 
                        // 行動支付：霧霾藍 (Haze Blue)
                        mobile: { 100: '#E0F2FE', 500: '#94A3B8', 600: '#64748B' },
                        // 信用卡：乾燥玫瑰 (Dusty Rose)
                        card: { 100: '#FFE4E6', 500: '#E5989B', 600: '#B5838D' },
                        // 強調色
                        accent: '#B5838D'
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'inner-soft': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.02)',
                        'float': '0 10px 30px -10px rgba(0, 0, 0, 0.1)',
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* 全局設定 */
        html, body, #root { height: 100%; overflow: hidden; background-color: #FAFAF9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* 隱藏捲軸 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 安全區域 */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* 毛玻璃 */
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.03); }
        
        /* 特殊字體優化 */
        .num-font { font-family: 'SF Pro Display', 'Roboto', sans-serif; letter-spacing: -0.5px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 資料庫 Key ---
        const DB_KEY = 'cfs_transactions_v1';

        // --- 工具函式 ---
        const getTodayStr = () => new Date().toISOString().split('T')[0];
        const formatMoney = (n) => new Intl.NumberFormat('en-US').format(n);
        
        // --- 圖示對應 ---
        const CAT_ICONS = {
            '飲食': 'fa-utensils', '交通': 'fa-train-subway', '購物': 'fa-bag-shopping', 
            '娛樂': 'fa-film', '居家': 'fa-house', '其他': 'fa-shapes',
            '薪資': 'fa-money-bill-wave', '投資': 'fa-chart-line', '轉帳': 'fa-right-left'
        };

        // --- 支付方式設定 (核心靈魂) ---
        const METHODS = {
            cash: { id: 'cash', label: '現金', color: 'text-cash-600', bg: 'bg-cash-100', border: 'border-cash-500', icon: 'fa-coins' },
            mobile: { id: 'mobile', label: '行動', color: 'text-mobile-600', bg: 'bg-mobile-100', border: 'border-mobile-500', icon: 'fa-mobile-screen' },
            card: { id: 'card', label: '信用卡', color: 'text-card-600', bg: 'bg-card-100', border: 'border-card-500', icon: 'fa-credit-card' }
        };

        // --- 元件: Header ---
        const Header = ({ period, setPeriod, date, setDate }) => {
            const handlePrev = () => {
                const d = new Date(date);
                if(period === 'day') d.setDate(d.getDate() - 1);
                else d.setMonth(d.getMonth() - 1);
                setDate(d.toISOString().split('T')[0]);
            };
            const handleNext = () => {
                const d = new Date(date);
                if(period === 'day') d.setDate(d.getDate() + 1);
                else d.setMonth(d.getMonth() + 1);
                setDate(d.toISOString().split('T')[0]);
            };

            const displayDate = useMemo(() => {
                const d = new Date(date);
                if (period === 'day') return `${d.getMonth()+1}月${d.getDate()}日`;
                return `${d.getFullYear()}年 ${d.getMonth()+1}月`;
            }, [date, period]);

            return (
                <div className="fixed top-0 left-0 right-0 z-50 glass safe-top">
                    <div className="flex items-center justify-between px-4 h-[60px]">
                        <div className="flex bg-base-200 rounded-lg p-1">
                            {['day', 'month'].map(p => (
                                <button key={p} onClick={() => setPeriod(p)} 
                                    className={`px-3 py-1 rounded-md text-xs font-medium transition-all ${period === p ? 'bg-white text-base-800 shadow-sm' : 'text-base-800/50'}`}>
                                    {p === 'day' ? '日' : '月'}
                                </button>
                            ))}
                        </div>
                        
                        <div className="flex items-center gap-4">
                            <button onClick={handlePrev} className="text-base-800/40 hover:text-base-800 px-2"><i className="fa-solid fa-chevron-left text-sm"></i></button>
                            <span className="text-base font-bold text-base-800 num-font tracking-wide">{displayDate}</span>
                            <button onClick={handleNext} className="text-base-800/40 hover:text-base-800 px-2"><i className="fa-solid fa-chevron-right text-sm"></i></button>
                        </div>

                        <div className="w-8"></div> {/* Placeholder balance layout */}
                    </div>
                </div>
            );
        };

        // --- 元件: 感知儀表板 (Dashboard) ---
        const Dashboard = ({ stats }) => {
            const totalExp = stats.expense;
            
            // 計算比例
            const getPct = (val) => totalExp === 0 ? 0 : (val / totalExp) * 100;
            const cashPct = getPct(stats.byMethod.cash);
            const mobilePct = getPct(stats.byMethod.mobile);
            const cardPct = getPct(stats.byMethod.card);

            // 找出最大佔比
            const maxVal = Math.max(stats.byMethod.cash, stats.byMethod.mobile, stats.byMethod.card);
            let dominantMethod = null;
            if (maxVal > 0) {
                if (maxVal === stats.byMethod.card) dominantMethod = 'card';
                else if (maxVal === stats.byMethod.mobile) dominantMethod = 'mobile';
                else dominantMethod = 'cash';
            }

            return (
                <div className="px-5 pt-4 pb-2">
                    <div className="bg-white rounded-2xl p-5 shadow-soft border border-base-200 relative overflow-hidden">
                        
                        {/* 氛圍背景光暈 */}
                        {dominantMethod === 'card' && <div className="absolute top-0 right-0 w-32 h-32 bg-card-100 rounded-full blur-3xl -mr-10 -mt-10 opacity-60"></div>}
                        {dominantMethod === 'mobile' && <div className="absolute top-0 right-0 w-32 h-32 bg-mobile-100 rounded-full blur-3xl -mr-10 -mt-10 opacity-60"></div>}
                        {dominantMethod === 'cash' && <div className="absolute top-0 right-0 w-32 h-32 bg-cash-100 rounded-full blur-3xl -mr-10 -mt-10 opacity-60"></div>}

                        <div className="relative z-10">
                            <div className="text-xs text-base-800/60 font-medium tracking-wider mb-1">本期總支出</div>
                            <div className="text-3xl font-bold text-base-900 num-font mb-6">${formatMoney(stats.expense)}</div>
                            
                            {/* 視覺化佔比條 */}
                            <div className="flex h-3 rounded-full overflow-hidden bg-base-100 mb-3">
                                <div style={{width: `${cashPct}%`}} className="bg-cash-500 transition-all duration-500"></div>
                                <div style={{width: `${mobilePct}%`}} className="bg-mobile-500 transition-all duration-500"></div>
                                <div style={{width: `${cardPct}%`}} className="bg-card-500 transition-all duration-500"></div>
                            </div>

                            <div className="flex justify-between text-[10px] text-base-800/50 font-medium">
                                <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-cash-500"></div>現金 {Math.round(cashPct)}%</div>
                                <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-mobile-500"></div>行動 {Math.round(mobilePct)}%</div>
                                <div className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-card-500"></div>信用卡 {Math.round(cardPct)}%</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 元件: 列表 (List) ---
        const TransactionList = ({ list, onDelete }) => {
            if (list.length === 0) {
                return (
                    <div className="flex flex-col items-center justify-center py-20 opacity-30">
                        <i className="fa-solid fa-leaf text-4xl mb-3 text-base-800"></i>
                        <span className="text-sm text-base-800">感受當下，記下一筆</span>
                    </div>
                );
            }

            return (
                <div className="px-5 pb-24 space-y-3">
                    {list.map(t => {
                        // 根據支付方式決定顏色樣式
                        const m = METHODS[t.method] || METHODS.cash;
                        const isExp = t.type === 'expense';
                        
                        return (
                            <div key={t.id} className="bg-white p-4 rounded-xl shadow-sm border border-base-100 flex items-center justify-between group active:scale-[0.99] transition-transform">
                                <div className="flex items-center gap-4">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ${isExp ? 'bg-base-100 text-base-800' : 'bg-cash-100 text-cash-600'}`}>
                                        <i className={`fa-solid ${CAT_ICONS[t.category] || 'fa-pen'}`}></i>
                                    </div>
                                    <div>
                                        <div className="text-sm font-bold text-base-800">{t.category}</div>
                                        <div className="flex items-center gap-1 mt-1">
                                            {isExp && <i className={`fa-solid ${m.icon} text-[10px] ${m.color}`}></i>}
                                            <span className="text-xs text-base-800/40">{isExp ? m.label : '收入'}</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex flex-col items-end">
                                    <span className={`text-base font-bold num-font ${isExp ? m.color : 'text-cash-600'}`}>
                                        {isExp ? '-' : '+'}{formatMoney(t.amount)}
                                    </span>
                                    <button onClick={(e) => { e.stopPropagation(); onDelete(t.id); }} className="text-xs text-base-200 mt-1 px-2 py-1 -mr-2 hover:text-card-500 transition-colors">
                                        <i className="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- 元件: 新增 Modal ---
        const AddModal = ({ show, onClose, onSave, date }) => {
            if (!show) return null;

            const [amount, setAmount] = useState('');
            const [type, setType] = useState('expense');
            const [method, setMethod] = useState(''); // 必選
            const [cat, setCat] = useState('');

            const catsExp = ['飲食', '交通', '購物', '娛樂', '居家', '其他'];
            const catsInc = ['薪資', '投資', '轉帳', '其他'];
            const currentCats = type === 'expense' ? catsExp : catsInc;

            const handleSubmit = () => {
                if (!amount) return;
                if (type === 'expense' && !method) {
                    alert('請選擇支付方式'); // 簡單阻擋，理想應為 Toast
                    return;
                }
                onSave({
                    id: Date.now(),
                    date,
                    amount: parseFloat(amount),
                    type,
                    method: type === 'income' ? 'cash' : method,
                    category: cat || '其他'
                });
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[100] flex flex-col justify-end">
                    <div className="absolute inset-0 bg-base-900/20 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white rounded-t-3xl p-6 pb-10 w-full animate-slide-up shadow-float relative z-10 safe-bottom">
                        
                        <div className="w-12 h-1 bg-base-200 rounded-full mx-auto mb-6"></div>

                        {/* 收支切換 */}
                        <div className="flex justify-center mb-6">
                            <div className="flex bg-base-100 p-1 rounded-full">
                                <button onClick={() => {setType('expense'); setMethod('');}} className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${type === 'expense' ? 'bg-white shadow-sm text-base-800' : 'text-base-400'}`}>支出</button>
                                <button onClick={() => setType('income')} className={`px-6 py-2 rounded-full text-sm font-bold transition-all ${type === 'income' ? 'bg-white shadow-sm text-base-800' : 'text-base-400'}`}>收入</button>
                            </div>
                        </div>

                        {/* 金額輸入 */}
                        <div className="mb-8 text-center relative">
                            <span className="text-2xl text-base-400 font-bold align-top mt-2 inline-block">$</span>
                            <input type="number" inputMode="decimal" value={amount} onChange={e => setAmount(e.target.value)} 
                                className="text-5xl font-bold text-base-800 w-2/3 text-center border-none focus:outline-none bg-transparent num-font placeholder-base-200"
                                placeholder="0" autoFocus />
                        </div>

                        {/* 支付方式 (核心) - 僅支出顯示 */}
                        {type === 'expense' && (
                            <div className="mb-8">
                                <div className="text-xs text-base-400 font-bold text-center mb-3 tracking-widest uppercase">支付方式</div>
                                <div className="grid grid-cols-3 gap-3">
                                    {Object.values(METHODS).map(m => (
                                        <button key={m.id} onClick={() => setMethod(m.id)}
                                            className={`py-3 rounded-xl flex flex-col items-center justify-center gap-1 transition-all border-2 ${method === m.id ? `${m.bg} ${m.border} ${m.color}` : 'bg-base-50 border-transparent text-base-400'}`}>
                                            <i className={`fa-solid ${m.icon} text-xl mb-1`}></i>
                                            <span className="text-xs font-bold">{m.label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 分類選擇 */}
                        <div className="mb-8">
                            <div className="text-xs text-base-400 font-bold text-center mb-3 tracking-widest uppercase">分類項目</div>
                            <div className="flex flex-wrap gap-2 justify-center">
                                {currentCats.map(c => (
                                    <button key={c} onClick={() => setCat(c)}
                                        className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${cat === c ? 'bg-base-800 text-white' : 'bg-base-100 text-base-500'}`}>
                                        {c}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <button onClick={handleSubmit} className="w-full bg-base-800 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform">
                            完成紀錄
                        </button>
                    </div>
                </div>
            );
        };

        // --- App 主程式 ---
        const App = () => {
            const [transactions, setTransactions] = useState([]);
            const [period, setPeriod] = useState('day'); // 'day' or 'month'
            const [date, setDate] = useState(getTodayStr());
            const [showAdd, setShowAdd] = useState(false);

            // 讀取資料
            useEffect(() => {
                const saved = localStorage.getItem(DB_KEY);
                if (saved) setTransactions(JSON.parse(saved));
            }, []);

            // 存檔
            const handleSaveTx = (newTx) => {
                const updated = [newTx, ...transactions];
                setTransactions(updated);
                localStorage.setItem(DB_KEY, JSON.stringify(updated));
            };

            const handleDelete = (id) => {
                if(!confirm('確定刪除此紀錄？')) return;
                const updated = transactions.filter(t => t.id !== id);
                setTransactions(updated);
                localStorage.setItem(DB_KEY, JSON.stringify(updated));
            };

            // 統計計算
            const stats = useMemo(() => {
                const targetPrefix = period === 'day' ? date : date.slice(0, 7); // '2023-10-27' or '2023-10'
                
                const filtered = transactions.filter(t => t.date.startsWith(targetPrefix));
                
                const income = filtered.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
                const expense = filtered.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
                
                const byMethod = { cash: 0, mobile: 0, card: 0 };
                filtered.filter(t => t.type === 'expense').forEach(t => {
                    if (byMethod[t.method] !== undefined) byMethod[t.method] += t.amount;
                });

                return { list: filtered, income, expense, byMethod };
            }, [transactions, period, date]);

            return (
                <div className="h-full flex flex-col">
                    {/* 上方導航 */}
                    <Header period={period} setPeriod={setPeriod} date={date} setDate={setDate} />
                    
                    {/* 主要內容區 (可捲動) */}
                    <div className="flex-1 overflow-y-auto pt-[60px] no-scrollbar">
                        <Dashboard stats={stats} />
                        
                        <div className="mt-4">
                            <div className="px-5 mb-2 flex items-center justify-between">
                                <span className="text-xs font-bold text-base-400 tracking-wider">近期紀錄</span>
                                <span className="text-[10px] text-base-300 bg-base-100 px-2 py-1 rounded-full">{stats.list.length} 筆</span>
                            </div>
                            <TransactionList list={stats.list} onDelete={handleDelete} />
                        </div>
                    </div>

                    {/* 浮動按鈕 (FAB) */}
                    <div className="fixed bottom-8 left-0 right-0 flex justify-center z-40 pointer-events-none safe-bottom">
                        <button onClick={() => setShowAdd(true)} 
                            className="bg-base-800 text-white w-14 h-14 rounded-full shadow-float flex items-center justify-center text-2xl active:scale-90 transition-transform pointer-events-auto hover:bg-base-900">
                            <i className="fa-solid fa-plus"></i>
                        </button>
                    </div>

                    {/* 新增 Modal */}
                    <AddModal show={showAdd} onClose={() => setShowAdd(false)} onSave={handleSaveTx} date={date} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // 註冊 PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js');
        }
    </script>
</body>
</html>