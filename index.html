<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CashFlow Sense v1.1</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#FAFAF9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icon-192.png">

    <!-- 資源載入 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 莫蘭迪色系設定 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        base: { 50: '#FAFAF9', 100: '#F5F5F4', 200: '#E7E5E4', 500: '#78716C', 800: '#44403C', 900: '#292524' },
                        // 現金 (Sage)
                        cash: { 100: '#ECFDF5', 500: '#10B981', 600: '#059669' },
                        // 行動 (Slate/Blue Grey)
                        mobile: { 100: '#F1F5F9', 500: '#64748B', 600: '#475569' },
                        // 信用卡 (Rose/Terracotta)
                        card: { 100: '#FFF1F2', 500: '#F43F5E', 600: '#E11D48' },
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'float': '0 10px 30px -10px rgba(0, 0, 0, 0.08)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        html, body, #root { height: 100%; overflow: hidden; background-color: #FAFAF9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .num-font { font-family: 'SF Pro Display', 'Roboto', sans-serif; letter-spacing: -0.5px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const DB_KEY = 'cfs_db_v1';

        // --- Utils ---
        const getToday = () => new Date().toISOString().split('T')[0];
        const formatMoney = (n) => new Intl.NumberFormat('en-US').format(n);
        const getCalendarDays = (year, month) => {
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            let days = [];
            for(let i=0; i<firstDay.getDay(); i++) days.push(null);
            for(let i=1; i<=lastDay.getDate(); i++) {
                const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                days.push({ day: i, dateStr });
            }
            return days;
        };

        // --- Icons & Config ---
        const METHODS = {
            cash: { id: 'cash', label: '現金', color: 'text-cash-600', bg: 'bg-cash-100', icon: 'fa-coins' },
            mobile: { id: 'mobile', label: '行動', color: 'text-mobile-600', bg: 'bg-mobile-100', icon: 'fa-mobile-screen' },
            card: { id: 'card', label: '信用卡', color: 'text-card-600', bg: 'bg-card-100', icon: 'fa-credit-card' },
            bank: { id: 'bank', label: '轉帳', color: 'text-base-500', bg: 'bg-base-200', icon: 'fa-building-columns' } // For Income
        };

        // --- Pages Components ---

        // 1. Home Page
        const HomePage = ({ balance, recentTx, onOpenAdd }) => (
            <div className="flex flex-col h-full animate-fade-in px-6 pt-6">
                
                {/* Logo & Version Area */}
                <div className="mt-4 mb-6 flex flex-col items-center justify-center safe-top">
                    <div className="w-16 h-16 bg-white rounded-2xl shadow-soft flex items-center justify-center text-base-800 mb-3 border border-base-100">
                        <i className="fa-solid fa-wallet text-3xl"></i>
                    </div>
                    <h1 className="text-xl font-bold text-base-900 tracking-wide">Cash Flow Sense</h1>
                    <span className="text-[10px] text-base-400 font-bold bg-base-200 px-2 py-0.5 rounded-full mt-1">v1.1</span>
                </div>

                {/* Net Asset Card */}
                <div className="bg-base-800 text-white rounded-2xl p-6 shadow-float mb-8 relative overflow-hidden">
                    <div className="absolute right-[-20px] top-[-20px] w-32 h-32 bg-white opacity-5 rounded-full blur-2xl"></div>
                    <div className="text-xs text-base-300 font-medium tracking-wider mb-1">淨資產結餘</div>
                    <div className="text-4xl font-bold num-font">${formatMoney(balance)}</div>
                </div>

                {/* Action Buttons */}
                <div className="grid grid-cols-2 gap-4 mb-8">
                    <button onClick={() => onOpenAdd('income')} className="bg-white border border-base-200 rounded-xl py-4 shadow-soft active:scale-95 transition-transform flex flex-col items-center gap-2">
                        <div className="w-10 h-10 rounded-full bg-cash-100 text-cash-600 flex items-center justify-center"><i className="fa-solid fa-plus"></i></div>
                        <span className="text-sm font-bold text-base-600">記進帳</span>
                    </button>
                    <button onClick={() => onOpenAdd('expense')} className="bg-white border border-base-200 rounded-xl py-4 shadow-soft active:scale-95 transition-transform flex flex-col items-center gap-2">
                        <div className="w-10 h-10 rounded-full bg-card-100 text-card-600 flex items-center justify-center"><i className="fa-solid fa-minus"></i></div>
                        <span className="text-sm font-bold text-base-600">記支出</span>
                    </button>
                </div>

                {/* Recent List Header */}
                <div className="flex justify-between items-center mb-2">
                    <span className="text-xs font-bold text-base-400 uppercase tracking-widest">近期紀錄</span>
                </div>
                
                <div className="flex-1 overflow-y-auto pb-24 no-scrollbar">
                    {recentTx.length === 0 ? (
                        <div className="text-center text-base-300 text-xs py-10">尚無紀錄，開始記帳吧</div>
                    ) : (
                        recentTx.map(t => <TxItem key={t.id} tx={t} />)
                    )}
                </div>
            </div>
        );

        // 2. Calendar Page
        const CalendarPage = ({ transactions, currentMonth, setCurrentMonth }) => {
            const [selectedDate, setSelectedDate] = useState(getToday());
            
            const days = useMemo(() => getCalendarDays(new Date().getFullYear(), currentMonth), [currentMonth]);
            
            const dailyTx = useMemo(() => transactions.filter(t => t.date === selectedDate), [selectedDate, transactions]);

            const hasTx = (dateStr) => transactions.some(t => t.date === dateStr);

            return (
                <div className="flex flex-col h-full animate-fade-in pt-safe-top">
                    {/* Month Switcher */}
                    <div className="flex items-center justify-between px-6 py-4 bg-base-50 sticky top-0 z-10 safe-top">
                        <button onClick={() => setCurrentMonth(m => m===1?12:m-1)} className="w-8 h-8 flex items-center justify-center text-base-400 hover:text-base-800"><i className="fa-solid fa-chevron-left"></i></button>
                        <span className="text-lg font-bold text-base-800">{currentMonth}月</span>
                        <button onClick={() => setCurrentMonth(m => m===12?1:m+1)} className="w-8 h-8 flex items-center justify-center text-base-400 hover:text-base-800"><i className="fa-solid fa-chevron-right"></i></button>
                    </div>

                    <div className="flex-1 overflow-y-auto no-scrollbar pb-24">
                        {/* Calendar Grid */}
                        <div className="px-4 mb-6">
                            <div className="grid grid-cols-7 text-center mb-2">
                                {['日','一','二','三','四','五','六'].map(d => <span key={d} className="text-[10px] text-base-400 font-bold">{d}</span>)}
                            </div>
                            <div className="grid grid-cols-7 gap-1">
                                {days.map((d, i) => {
                                    if(!d) return <div key={i} className="aspect-square"></div>;
                                    const isSelected = d.dateStr === selectedDate;
                                    const active = hasTx(d.dateStr);
                                    return (
                                        <div key={i} onClick={() => setSelectedDate(d.dateStr)} 
                                            className={`aspect-square rounded-lg flex flex-col items-center justify-center text-xs font-bold cursor-pointer transition-all border ${isSelected ? 'bg-base-800 text-white border-base-800 shadow-md' : 'bg-white text-base-600 border-transparent hover:bg-base-100'}`}>
                                            {d.day}
                                            {active && !isSelected && <div className="w-1 h-1 rounded-full bg-card-500 mt-1"></div>}
                                        </div>
                                    )
                                })}
                            </div>
                        </div>

                        {/* Daily List */}
                        <div className="px-4">
                            <div className="text-xs font-bold text-base-400 mb-3 bg-base-200 inline-block px-2 py-1 rounded">
                                {selectedDate}
                            </div>
                            {dailyTx.length === 0 ? (
                                <div className="text-center text-base-300 text-xs py-4">本日無紀錄</div>
                            ) : (
                                dailyTx.map(t => <TxItem key={t.id} tx={t} />)
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Analysis Page
        const AnalysisPage = ({ transactions, currentMonth }) => {
            const stats = useMemo(() => {
                const filtered = transactions.filter(t => {
                    const d = new Date(t.date);
                    return (d.getMonth() + 1) === currentMonth && t.type === 'expense';
                });
                
                const total = filtered.reduce((sum, t) => sum + t.amount, 0);
                const byMethod = { cash: 0, mobile: 0, card: 0 };
                
                filtered.forEach(t => {
                    if (byMethod[t.method] !== undefined) byMethod[t.method] += t.amount;
                });

                return { total, byMethod };
            }, [transactions, currentMonth]);

            const getPct = (val) => stats.total === 0 ? 0 : Math.round((val / stats.total) * 100);

            return (
                <div className="flex flex-col h-full animate-fade-in px-6 pt-safe-top">
                    <div className="py-6">
                        <h2 className="text-2xl font-bold text-base-800 mb-1">{currentMonth}月支付分析</h2>
                        <p className="text-xs text-base-400">總支出 ${formatMoney(stats.total)}</p>
                    </div>

                    <div className="space-y-4">
                        <MethodCard method="cash" amount={stats.byMethod.cash} pct={getPct(stats.byMethod.cash)} />
                        <MethodCard method="mobile" amount={stats.byMethod.mobile} pct={getPct(stats.byMethod.mobile)} />
                        <MethodCard method="card" amount={stats.byMethod.card} pct={getPct(stats.byMethod.card)} />
                    </div>
                </div>
            );
        };

        // --- Sub Components ---

        const TxItem = ({ tx }) => {
            const m = METHODS[tx.method] || METHODS.cash;
            const isExp = tx.type === 'expense';
            return (
                <div className="flex items-center justify-between p-4 bg-white rounded-xl mb-2 border border-base-100 shadow-sm">
                    <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ${isExp ? m.bg + ' ' + m.color : 'bg-cash-100 text-cash-600'}`}>
                            <i className={`fa-solid ${isExp ? m.icon : 'fa-arrow-down'}`}></i>
                        </div>
                        <div>
                            <div className="text-sm font-bold text-base-800">{tx.category}</div>
                            {isExp && <div className="text-[10px] text-base-400">{m.label}</div>}
                        </div>
                    </div>
                    <div className={`text-base font-bold num-font ${isExp ? m.color : 'text-cash-600'}`}>
                        {isExp ? '-' : '+'}{formatMoney(tx.amount)}
                    </div>
                </div>
            )
        };

        const MethodCard = ({ method, amount, pct }) => {
            const m = METHODS[method];
            return (
                <div className="bg-white p-5 rounded-2xl shadow-sm border border-base-100 flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl ${m.bg} ${m.color}`}>
                            <i className={`fa-solid ${m.icon}`}></i>
                        </div>
                        <div>
                            <div className="text-sm font-bold text-base-800">{m.label}</div>
                            <div className="w-24 h-1.5 bg-base-100 rounded-full mt-2 overflow-hidden">
                                <div style={{width: `${pct}%`}} className={`h-full rounded-full ${m.color.replace('text', 'bg')}`}></div>
                            </div>
                        </div>
                    </div>
                    <div className="text-right">
                        <div className="text-lg font-bold text-base-800 num-font">${formatMoney(amount)}</div>
                        <div className="text-xs text-base-400 font-bold">{pct}%</div>
                    </div>
                </div>
            );
        };

        // --- Add Modal ---
        const AddModal = ({ mode, onClose, onSave }) => {
            const [amount, setAmount] = useState('');
            const [method, setMethod] = useState(mode === 'income' ? 'cash' : '');
            const [cat, setCat] = useState('');
            const [date, setDate] = useState(getToday());

            const cats = mode === 'income' 
                ? ['薪資', '獎金', '投資', '其他'] 
                : ['飲食', '交通', '購物', '娛樂', '居家', '其他'];

            const handleSubmit = () => {
                if(!amount) return;
                if(mode === 'expense' && !method) { alert('請選擇支付方式'); return; }
                onSave({
                    id: Date.now(),
                    date,
                    amount: parseFloat(amount),
                    type: mode,
                    method,
                    category: cat || '其他'
                });
                onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex flex-col justify-end">
                    <div className="absolute inset-0 bg-base-900/30 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white rounded-t-3xl p-6 w-full animate-slide-up relative z-10 safe-bottom">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-bold text-base-800">{mode === 'income' ? '記進帳' : '記支出'}</h3>
                            <input type="date" value={date} onChange={e => setDate(e.target.value)} className="bg-base-100 text-xs font-bold px-2 py-1 rounded text-base-500 outline-none"/>
                        </div>
                        
                        <div className="mb-6 relative text-center">
                            <span className="text-2xl font-bold text-base-300 absolute top-2 left-4">$</span>
                            <input type="number" value={amount} onChange={e => setAmount(e.target.value)} autoFocus placeholder="0"
                                className="w-full text-center text-5xl font-bold text-base-800 outline-none bg-transparent num-font placeholder-base-200" />
                        </div>

                        {mode === 'expense' && (
                            <div className="mb-6">
                                <label className="text-xs font-bold text-base-400 uppercase tracking-widest mb-3 block text-center">支付方式</label>
                                <div className="grid grid-cols-3 gap-3">
                                    {['cash', 'mobile', 'card'].map(k => (
                                        <button key={k} onClick={() => setMethod(k)}
                                            className={`py-3 rounded-xl flex flex-col items-center gap-1 border-2 transition-all ${method === k ? METHODS[k].bg + ' ' + METHODS[k].border + ' ' + METHODS[k].color : 'border-transparent bg-base-50 text-base-400'}`}>
                                            <i className={`fa-solid ${METHODS[k].icon}`}></i>
                                            <span className="text-xs font-bold">{METHODS[k].label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="mb-8">
                            <label className="text-xs font-bold text-base-400 uppercase tracking-widest mb-3 block text-center">分類</label>
                            <div className="flex flex-wrap gap-2 justify-center">
                                {cats.map(c => (
                                    <button key={c} onClick={() => setCat(c)} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${cat === c ? 'bg-base-800 text-white' : 'bg-base-100 text-base-500'}`}>
                                        {c}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <button onClick={handleSubmit} className={`w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg active:scale-95 transition-transform ${mode === 'income' ? 'bg-cash-500' : 'bg-base-800'}`}>
                            確認{mode === 'income' ? '進帳' : '支出'}
                        </button>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [page, setPage] = useState('home'); // home, calendar, analysis
            const [txs, setTxs] = useState([]);
            const [modalMode, setModalMode] = useState(null); // 'income', 'expense', null
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth() + 1);

            useEffect(() => {
                const data = localStorage.getItem(DB_KEY);
                if(data) setTxs(JSON.parse(data));
            }, []);

            const handleSave = (newTx) => {
                const updated = [newTx, ...txs];
                setTxs(updated);
                localStorage.setItem(DB_KEY, JSON.stringify(updated));
            };

            const balance = useMemo(() => {
                return txs.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
            }, [txs]);

            const NavBtn = ({ id, icon, label }) => (
                <button onClick={() => setPage(id)} className={`flex-1 flex flex-col items-center justify-center gap-1 py-2 ${page === id ? 'text-base-800' : 'text-base-400'}`}>
                    <i className={`fa-solid ${icon} text-xl mb-0.5 ${page === id ? 'animate-bounce' : ''}`}></i>
                    <span className="text-[10px] font-bold">{label}</span>
                </button>
            );

            return (
                <div className="h-full flex flex-col bg-base-50">
                    <div className="flex-1 overflow-hidden relative">
                        {page === 'home' && <HomePage balance={balance} recentTx={txs.slice(0,5)} onOpenAdd={setModalMode} />}
                        {page === 'calendar' && <CalendarPage transactions={txs} currentMonth={currentMonth} setCurrentMonth={setCurrentMonth} />}
                        {page === 'analysis' && <AnalysisPage transactions={txs} currentMonth={currentMonth} />}
                    </div>

                    {/* Bottom Navigation */}
                    <div className="h-[80px] bg-white border-t border-base-200 flex items-start pt-2 safe-bottom z-40">
                        <NavBtn id="home" icon="fa-house" label="首頁" />
                        <NavBtn id="calendar" icon="fa-calendar-days" label="月曆" />
                        <NavBtn id="analysis" icon="fa-chart-pie" label="分析" />
                    </div>

                    {modalMode && <AddModal mode={modalMode} onClose={() => setModalMode(null)} onSave={handleSave} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
    </script>
</body>
</html>