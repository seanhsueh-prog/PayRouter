<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CashFlow Sense v3.3</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#F8FAFC"> <!-- Slate-50 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <!-- è³‡æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- è¦–è¦ºç³»çµ± v3.3: Final Polish -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        base: { 50: '#F8FAFC', 100: '#F1F5F9', 200: '#E2E8F0', 300: '#CBD5E1', 800: '#1E293B', 900: '#0F172A' },
                        sky: { 50: '#F0F9FF', 500: '#0EA5E9' },
                    },
                    boxShadow: {
                        'powder': '0 10px 25px -5px rgba(186, 230, 253, 0.6), 0 8px 10px -6px rgba(186, 230, 253, 0.3)',
                        'float': '0 10px 30px -10px rgba(14, 165, 233, 0.15)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
                    },
                    fontFamily: { 'num': ['SF Pro Display', 'Roboto', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        html, body, #root { height: 100%; overflow: hidden; background-color: #F8FAFC; }
        body { -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.4); }
        .murmur-glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 8px 32px 0 rgba(186, 230, 253, 0.3); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const DB_KEY = 'cfs_db_v1';
        const NOTE_KEY = 'cfs_notes_v1';

        // --- Utils ---
        const getToday = () => new Date().toISOString().split('T')[0];
        const formatMoney = (n) => new Intl.NumberFormat('en-US').format(n);
        const getCalendarDays = (year, month) => {
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            let days = [];
            for(let i=0; i<firstDay.getDay(); i++) days.push(null);
            for(let i=1; i<=lastDay.getDate(); i++) {
                days.push({ day: i, dateStr: `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}` });
            }
            return days;
        };

        // --- Config ---
        const METHODS = {
            cash: { id: 'cash', label: 'ç¾é‡‘', painType: 'solid', color: 'text-emerald-700', bg: 'bg-emerald-100', bar: 'bg-emerald-600', icon: 'fa-coins' },
            mobile: { id: 'mobile', label: 'è¡Œå‹•', painType: 'ghost', color: 'text-sky-600', bg: 'bg-sky-100', bar: 'bg-gradient-to-r from-sky-400 to-sky-200', icon: 'fa-mobile-screen' },
            card: { id: 'card', label: 'ä¿¡ç”¨å¡', painType: 'ghost', color: 'text-rose-500', bg: 'bg-rose-50', bar: 'bg-gradient-to-r from-rose-400 to-rose-200', icon: 'fa-credit-card' },
            bank: { id: 'bank', label: 'è½‰å¸³', painType: 'solid', color: 'text-slate-600', bg: 'bg-slate-100', bar: 'bg-slate-500', icon: 'fa-building-columns' }
        };

        // v3.3 Expanded Categories
        const CATS_EXPENSE = [
            'ğŸ± é£²é£Ÿ', 'ğŸš‡ äº¤é€š', 'ğŸ  å±…å®¶', 'ğŸ›ï¸ è³¼ç‰©', 'ğŸ¬ å¨›æ¨‚', 'ğŸ’Š é†«ç™‚', 
            'ğŸ“ æ•™è‚²', 'ğŸ¥‚ ç¤¾äº¤', 'ğŸ’„ ç¾å¦', 'ğŸ“± 3C', 'ğŸš— è»Šè¼›', 'ğŸ¶ å¯µç‰©'
        ];
        const CATS_INCOME = ['ğŸ’° è–ªè³‡', 'ğŸ§§ çé‡‘', 'ğŸ“ˆ æŠ•è³‡', 'ğŸ’¼ å…¼è·', 'ğŸ å…¶ä»–'];

        // --- Components ---

        // 1. Home Lobby (v3.3 Clean Header + Settings)
        const HomeLobby = ({ onNavigate, onOpenMemo, noteCount, onOpenSettings }) => {
            return (
                <div className="h-full flex flex-col p-6 animate-fade-in relative bg-base-50">
                    {/* Header: De-carded, Clean, with Gear */}
                    <div className="safe-top pt-4 pb-8 flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-2xl overflow-hidden shadow-sm border border-white">
                                <img src="./icons/icon-192.png" alt="Logo" className="w-full h-full object-cover" />
                            </div>
                            <div>
                                <h1 className="text-lg font-bold text-base-800 tracking-wide">CASH FLOW SENSE</h1>
                                <span className="text-[10px] text-base-400 font-bold tracking-widest">v3.3 FINAL</span>
                            </div>
                        </div>
                        <button onClick={onOpenSettings} className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-base-400 shadow-sm active:scale-90 transition-transform">
                            <i className="fa-solid fa-gear"></i>
                        </button>
                    </div>

                    {/* Matrix */}
                    <div className="flex-1 grid grid-cols-2 grid-rows-2 gap-5 pb-24">
                        <LobbyCard id="journal" title="æ—¥å¸¸" sub="Entry" icon="fa-pen-nib" theme="stone" onClick={()=>onNavigate('journal')} />
                        <LobbyCard id="insight" title="é€è¦–" sub="Insight" icon="fa-chart-pie" theme="sky" onClick={()=>onNavigate('insight')} />
                        <LobbyCard id="calendar" title="ç´€éŒ„" sub="Record" icon="fa-regular fa-calendar" theme="emerald" onClick={()=>onNavigate('calendar')} />
                        <LobbyCard id="vault" title="é‡‘åº«" sub="Asset" icon="fa-solid fa-vault" theme="rose" onClick={()=>onNavigate('vault')} isVault />
                    </div>

                    {/* Memo Glass Capsule */}
                    <div className="fixed bottom-8 left-6 right-6 safe-bottom z-30">
                        <button onClick={onOpenMemo} className="w-full murmur-glass rounded-2xl py-4 flex items-center justify-between px-6 active:scale-[0.98] transition-all hover:shadow-powder">
                            <div className="flex flex-col items-start">
                                <span className="text-base-800 text-sm font-bold tracking-wide">éš¨è¨˜ Memo...</span>
                                {noteCount > 0 && <span className="text-[10px] text-sky-500 font-bold mt-0.5">å·²æœ‰ {noteCount} å‰‡ç´€éŒ„</span>}
                            </div>
                            <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-sky-500 shadow-sm">
                                <i className="fa-solid fa-microphone"></i>
                            </div>
                        </button>
                    </div>
                </div>
            );
        };

        const LobbyCard = ({ id, title, sub, icon, theme, onClick, isVault }) => {
            const themes = { stone: 'text-slate-600', sky: 'text-sky-500', emerald: 'text-emerald-500', rose: 'text-rose-500' };
            return (
                <button onClick={onClick} className="group relative bg-white rounded-[2rem] shadow-powder p-5 flex flex-col justify-between items-start transition-all active:scale-[0.95] border border-white/60 overflow-hidden">
                    <div className={`absolute -right-4 -top-4 w-24 h-24 rounded-full opacity-10 blur-xl bg-current ${themes[theme]}`}></div>
                    <div className={`w-10 h-10 rounded-full bg-base-50 flex items-center justify-center ${themes[theme]} z-10 shadow-inner`}><i className={`fa-solid ${icon}`}></i></div>
                    <div className="z-10 w-full text-left mt-4">
                        <div className="text-[10px] text-base-300 font-bold uppercase tracking-wider mb-1">{sub}</div>
                        {isVault ? (
                            <div className="flex justify-between items-end w-full"><div className="text-xl font-bold text-base-800">{title}</div><i className="fa-solid fa-lock text-xs text-base-200 mb-1"></i></div>
                        ) : (<div className="text-xl font-bold text-base-800">{title}</div>)}
                    </div>
                </button>
            )
        };

        // 2. Page Container
        const PageContainer = ({ title, onBack, children, extraIcon, onExtraClick, noScroll }) => (
            <div className="h-full flex flex-col bg-base-50 animate-fade-in">
                <div className="safe-top glass-panel sticky top-0 z-50 flex-none">
                    <div className="h-[60px] flex items-center justify-between px-4">
                        <button onClick={onBack} className="bg-base-800 text-white rounded-full px-4 py-2 flex items-center gap-2 active:scale-90 transition-transform shadow-float hover:bg-base-900">
                            <i className="fa-solid fa-arrow-left text-xs"></i><span className="text-xs font-bold">è¿”å›</span>
                        </button>
                        <span className="text-base font-bold text-base-800 tracking-wide">{title}</span>
                        <div className="w-16 flex justify-end">
                            {extraIcon ? (
                                <button onClick={onExtraClick} className="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center text-base-800 active:bg-base-200 shadow-sm"><i className={`fa-solid ${extraIcon}`}></i></button>
                            ) : (<div className="w-10"></div>)}
                        </div>
                    </div>
                </div>
                <div className={`flex-1 relative ${noScroll ? 'overflow-hidden flex flex-col' : 'overflow-y-auto no-scrollbar'}`}>{children}</div>
            </div>
        );

        // 3. Journal Page (v3.3 Split View)
        const JournalPage = ({ transactions, onBack, onOpenAdd, onDelete }) => {
            const [filter, setFilter] = useState('all'); // all, income, expense
            
            const filteredTxs = useMemo(() => {
                if(filter === 'all') return transactions;
                return transactions.filter(t => t.type === filter);
            }, [transactions, filter]);

            return (
                <PageContainer title="æ—¥å¸¸ Journal" onBack={onBack}>
                    <div className="px-5 pt-4 pb-24">
                        {/* Segment Control */}
                        <div className="flex bg-white p-1 rounded-xl shadow-sm mb-4 border border-base-200">
                            <button onClick={()=>setFilter('all')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${filter==='all'?'bg-base-800 text-white':'text-base-400'}`}>å…¨éƒ¨</button>
                            <button onClick={()=>setFilter('income')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${filter==='income'?'bg-emerald-500 text-white':'text-base-400'}`}>æ”¶å…¥</button>
                            <button onClick={()=>setFilter('expense')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${filter==='expense'?'bg-rose-500 text-white':'text-base-400'}`}>æ”¯å‡º</button>
                        </div>

                        {filteredTxs.length === 0 ? (
                            <div className="py-20 text-center opacity-40"><i className="fa-solid fa-pen-nib text-4xl mb-3 text-base-300"></i><p className="text-sm text-base-400">å°šç„¡ç´€éŒ„</p></div>
                        ) : (
                            filteredTxs.slice(0, 30).map(t => <TxItem key={t.id} tx={t} onDelete={onDelete} />)
                        )}
                    </div>
                    <div className="fixed bottom-8 right-6 safe-bottom z-50 flex flex-col gap-3">
                        <button onClick={() => onOpenAdd('income')} className="w-12 h-12 rounded-full bg-white shadow-powder text-emerald-600 flex items-center justify-center active:scale-90 transition-transform border border-white"><i className="fa-solid fa-plus"></i></button>
                        <button onClick={() => onOpenAdd('expense')} className="w-14 h-14 rounded-full bg-base-800 shadow-float text-white flex items-center justify-center active:scale-90 transition-transform"><i className="fa-solid fa-minus text-xl"></i></button>
                    </div>
                </PageContainer>
            );
        };

        // 4. Insight Page
        const InsightPage = ({ transactions, onBack }) => {
            const [mode, setMode] = useState('method');
            const [year, setYear] = useState(new Date().getFullYear());
            const [month, setMonth] = useState(new Date().getMonth() + 1);

            const stats = useMemo(() => {
                const targetPrefix = `${year}-${String(month).padStart(2,'0')}`;
                const filtered = transactions.filter(t => t.type === 'expense' && t.date.startsWith(targetPrefix));
                const total = filtered.reduce((a, b) => a + b.amount, 0);
                const byMethod = { cash: 0, mobile: 0, card: 0 };
                const byCat = {};
                filtered.forEach(t => { 
                    if(byMethod[t.method] !== undefined) byMethod[t.method] += t.amount;
                    byCat[t.category] = (byCat[t.category] || 0) + t.amount;
                });
                const sortedCats = Object.entries(byCat).map(([k, v]) => ({ label: k, amount: v, pct: total===0?0:Math.round(v/total*100) })).sort((a,b) => b.amount - a.amount);
                return { total, byMethod, sortedCats };
            }, [transactions, year, month]);
            
            const getPct = (val) => stats.total === 0 ? 0 : Math.round((val / stats.total) * 100);
            const changeMonth = (delta) => { let m = month + delta; let y = year; if(m > 12) { m = 1; y++; } if(m < 1) { m = 12; y--; } setMonth(m); setYear(y); };

            return (
                <PageContainer title="é€è¦– Insight" onBack={onBack}>
                    <div className="px-6 pt-4 pb-10">
                        <div className="flex justify-center items-center gap-4 mb-6">
                            <button onClick={()=>changeMonth(-1)} className="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-base-400"><i className="fa-solid fa-chevron-left text-xs"></i></button>
                            <span className="text-base font-bold text-base-800 num-font">{year}å¹´ {month}æœˆ</span>
                            <button onClick={()=>changeMonth(1)} className="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-base-400"><i className="fa-solid fa-chevron-right text-xs"></i></button>
                        </div>
                        <div className="mb-6 text-center">
                            <div className="text-3xl font-bold text-base-800 font-num">${formatMoney(stats.total)}</div>
                            <div className="text-xs font-bold text-base-400 mt-1">ç¸½æ”¯å‡º</div>
                        </div>
                        <div className="flex justify-center mb-8">
                            <div className="bg-white p-1 rounded-full flex gap-1 shadow-sm border border-base-200">
                                <button onClick={() => setMode('method')} className={`px-5 py-2 rounded-full text-xs font-bold transition-all ${mode==='method'?'bg-base-800 text-white shadow-md':'text-base-400'}`}>æ”¯ä»˜æ–¹å¼</button>
                                <button onClick={() => setMode('category')} className={`px-5 py-2 rounded-full text-xs font-bold transition-all ${mode==='category'?'bg-base-800 text-white shadow-md':'text-base-400'}`}>æ¶ˆè²»é¡åˆ¥</button>
                            </div>
                        </div>
                        <div className="space-y-4 animate-fade-in">
                            {mode === 'method' ? (
                                <>
                                    <MethodBar label="ç¾é‡‘" sub="å¯¦æ„Ÿæ”¯å‡º" icon="fa-coins" color={METHODS.cash.color} bar={METHODS.cash.bar} amount={stats.byMethod.cash} pct={getPct(stats.byMethod.cash)} painType="solid" />
                                    <MethodBar label="è¡Œå‹•" sub="ç„¡ç—›ç´¯ç©" icon="fa-mobile-screen" color={METHODS.mobile.color} bar={METHODS.mobile.bar} amount={stats.byMethod.mobile} pct={getPct(stats.byMethod.mobile)} painType="ghost" />
                                    <MethodBar label="ä¿¡ç”¨å¡" sub="ç„¡ç—›ç´¯ç©" icon="fa-credit-card" color={METHODS.card.color} bar={METHODS.card.bar} amount={stats.byMethod.card} pct={getPct(stats.byMethod.card)} painType="ghost" />
                                </>
                            ) : (
                                stats.sortedCats.map((c, i) => <CategoryBar key={i} label={c.label} amount={c.amount} pct={c.pct} />)
                            )}
                        </div>
                    </div>
                </PageContainer>
            );
        };

        const MethodBar = ({ label, sub, icon, color, bar, amount, pct, painType }) => (
            <div className={`p-4 rounded-2xl shadow-powder border border-white/60 flex flex-col gap-3 ${painType === 'solid' ? 'bg-white' : 'bg-white/50 backdrop-blur-sm'}`}>
                <div className="flex justify-between items-center"><div className="flex items-center gap-2"><i className={`fa-solid ${icon} ${color}`}></i><div><span className="text-sm font-bold text-base-700 block">{label}</span><span className="text-[10px] text-base-400 font-bold block">{sub}</span></div></div><span className="text-sm font-bold font-num text-base-800">${formatMoney(amount)}</span></div>
                <div className="w-full h-3 bg-base-100 rounded-full overflow-hidden relative"><div style={{width: `${pct}%`}} className={`h-full ${bar} transition-all duration-500 absolute top-0 left-0 ${painType==='ghost'?'opacity-70':''}`}></div></div>
                <div className="text-right text-[10px] font-bold text-base-400">{pct}%</div>
            </div>
        );
        const CategoryBar = ({ label, amount, pct }) => (
            <div className="bg-white px-4 py-3 rounded-xl border border-white/60 shadow-sm flex items-center gap-3"><div className="w-12 text-xs font-bold text-base-600 truncate">{label}</div><div className="flex-1"><div className="flex justify-between text-[10px] text-base-400 mb-1"><span className="font-bold text-base-800">${formatMoney(amount)}</span><span>{pct}%</span></div><div className="w-full h-1.5 bg-base-100 rounded-full overflow-hidden"><div style={{width: `${pct}%`}} className="h-full bg-base-800 rounded-full"></div></div></div></div>
        );

        // 5. Record Page (v3.3 Split View + Search)
        const RecordPage = ({ transactions, onBack }) => {
            const [year, setYear] = useState(new Date().getFullYear());
            const [month, setMonth] = useState(new Date().getMonth() + 1);
            const [selectedDate, setSelectedDate] = useState(getToday());
            const [filter, setFilter] = useState('all');
            const [showSearch, setShowSearch] = useState(false);
            const [searchKw, setSearchKw] = useState('');

            const days = useMemo(() => getCalendarDays(year, month), [year, month]);
            
            const dailyTx = useMemo(() => {
                let tx = transactions.filter(t => t.date === selectedDate);
                if(filter !== 'all') tx = tx.filter(t => t.type === filter);
                return tx;
            }, [transactions, selectedDate, filter]);

            const hasTx = (d) => transactions.some(t => t.date === d);
            const changeMonth = (delta) => { let m = month + delta; let y = year; if(m > 12) { m = 1; y++; } if(m < 1) { m = 12; y--; } setMonth(m); setYear(y); };

            // Search Logic
            const searchResults = useMemo(() => {
                if(!searchKw) return [];
                return transactions.filter(t => t.category.includes(searchKw) || (t.note && t.note.includes(searchKw)) || t.amount.toString().includes(searchKw));
            }, [transactions, searchKw]);

            return (
                <PageContainer title="ç´€éŒ„ Record" onBack={onBack} extraIcon="fa-magnifying-glass" onExtraClick={()=>setShowSearch(true)} noScroll={true}>
                    {/* Calendar Header */}
                    <div className="flex-none bg-base-50 px-4 py-4 border-b border-base-200 z-10 shadow-sm">
                        <div className="flex justify-between items-center mb-4 px-2">
                            <button onClick={()=>changeMonth(-1)} className="w-8 h-8 flex items-center justify-center text-base-400 hover:text-base-800 bg-white rounded-full shadow-sm"><i className="fa-solid fa-chevron-left"></i></button>
                            <span className="text-lg font-bold text-base-800 num-font">{year}å¹´ {month}æœˆ</span>
                            <button onClick={()=>changeMonth(1)} className="w-8 h-8 flex items-center justify-center text-base-400 hover:text-base-800 bg-white rounded-full shadow-sm"><i className="fa-solid fa-chevron-right"></i></button>
                        </div>
                        <div className="grid grid-cols-7 gap-1">
                            {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d} className="text-center text-[10px] text-base-400 font-bold mb-1">{d}</div>)}
                            {days.map((d, i) => {
                                if(!d) return <div key={i}></div>;
                                const isSel = d.dateStr === selectedDate; const active = hasTx(d.dateStr);
                                return <div key={i} onClick={() => setSelectedDate(d.dateStr)} className={`aspect-square rounded-lg flex flex-col items-center justify-center text-xs font-bold transition-all cursor-pointer ${isSel ? 'bg-base-800 text-white shadow-lg' : 'bg-transparent text-base-600 hover:bg-base-200'}`}>{d.day}{active && !isSel && <div className="w-1 h-1 rounded-full bg-rose-400 mt-0.5"></div>}</div>
                            })}
                        </div>
                    </div>

                    {/* Scrollable List */}
                    <div className="flex-1 overflow-y-auto no-scrollbar p-4 bg-white/50">
                        {/* Split Filter */}
                        <div className="flex bg-white p-1 rounded-xl shadow-sm mb-4 border border-base-200 sticky top-0 z-20">
                            <button onClick={()=>setFilter('all')} className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold transition-all ${filter==='all'?'bg-base-800 text-white':'text-base-400'}`}>å…¨éƒ¨</button>
                            <button onClick={()=>setFilter('income')} className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold transition-all ${filter==='income'?'bg-emerald-500 text-white':'text-base-400'}`}>æ”¶å…¥</button>
                            <button onClick={()=>setFilter('expense')} className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold transition-all ${filter==='expense'?'bg-rose-500 text-white':'text-base-400'}`}>æ”¯å‡º</button>
                        </div>

                        <div className="text-xs font-bold text-base-400 mb-3 px-1">{selectedDate} æµæ°´å¸³</div>
                        {dailyTx.length === 0 ? <div className="text-center text-xs text-base-300 py-8">ç„¡ç´€éŒ„</div> : dailyTx.map(t => <TxItem key={t.id} tx={t} />)}
                        <div className="h-10"></div>
                    </div>

                    {/* v3.3 Search Overlay */}
                    {showSearch && (
                        <div className="absolute inset-0 bg-base-50 z-50 flex flex-col animate-fade-in">
                            <div className="p-4 bg-white border-b border-base-200 flex gap-3 safe-top">
                                <div className="flex-1 bg-base-100 rounded-xl flex items-center px-3">
                                    <i className="fa-solid fa-magnifying-glass text-base-400 text-sm"></i>
                                    <input autoFocus value={searchKw} onChange={e=>setSearchKw(e.target.value)} placeholder="æœå°‹å‚™è¨»ã€åˆ†é¡ã€é‡‘é¡..." className="bg-transparent w-full p-3 outline-none text-sm text-base-800" />
                                </div>
                                <button onClick={()=>{setShowSearch(false); setSearchKw('')}} className="text-base-500 font-bold text-sm">å–æ¶ˆ</button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4">
                                {searchKw && searchResults.length===0 && <div className="text-center text-xs text-base-300 mt-10">æ‰¾ä¸åˆ°ç›¸é—œç´€éŒ„</div>}
                                {searchResults.map(t => (
                                    <div key={t.id} className="mb-2">
                                        <div className="text-[10px] text-base-300 mb-1 ml-1">{t.date}</div>
                                        <TxItem tx={t} />
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </PageContainer>
            );
        };

        // 6. Vault Page
        const VaultPage = ({ transactions, onBack }) => {
            const [visible, setVisible] = useState(false);
            const net = useMemo(() => transactions.reduce((a, b) => b.type === 'income' ? a + b.amount : a - b.amount, 0), [transactions]);
            return (
                <PageContainer title="é‡‘åº« Vault" onBack={onBack}>
                    <div className="flex flex-col items-center justify-center h-[60vh] px-6">
                        <div className="w-20 h-20 bg-white rounded-full shadow-powder flex items-center justify-center text-rose-500 mb-6 border border-white"><i className={`fa-solid ${visible ? 'fa-lock-open' : 'fa-lock'} text-3xl`}></i></div>
                        <div className="text-xs font-bold text-base-400 uppercase tracking-widest mb-2">Total Assets</div>
                        <div onClick={() => setVisible(!visible)} className="text-4xl font-bold text-base-800 font-num cursor-pointer select-none">{visible ? `$${formatMoney(net)}` : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'}</div>
                        <p className="text-xs text-base-300 mt-4">é»æ“Šé¡¯ç¤º/éš±è—é‡‘é¡</p>
                    </div>
                </PageContainer>
            );
        };

        // 7. Settings Page (v3.3 Core: Backup & Restore)
        const SettingsPage = ({ onBack, transactions, notes, onRestore, onReset }) => {
            const downloadBackup = () => {
                const data = JSON.stringify({ transactions, notes, version: '3.3' });
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CfsBackup_${getToday()}.json`;
                a.click();
            };

            const triggerRestore = () => document.getElementById('restoreInput').click();
            const handleRestoreFile = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(data.transactions && data.notes) {
                            if(confirm(`ç¢ºèªé‚„åŸ ${data.transactions.length} ç­†å¸³å‹™èˆ‡ ${data.notes.length} å‰‡éš¨è¨˜ï¼Ÿ\nç¾æœ‰è³‡æ–™å°‡è¢«è¦†è“‹ã€‚`)) {
                                onRestore(data);
                                alert('é‚„åŸæˆåŠŸ');
                            }
                        } else alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                    } catch(err) { alert('æª”æ¡ˆè®€å–å¤±æ•—'); }
                };
                reader.readAsText(file);
            };

            return (
                <PageContainer title="è¨­å®š Settings" onBack={onBack}>
                    <div className="p-6 space-y-6">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-base-100">
                            <h3 className="font-bold text-base-800 mb-4">è³‡æ–™ä¿å…¨</h3>
                            <button onClick={downloadBackup} className="w-full bg-base-800 text-white py-3 rounded-xl font-bold mb-3 active:scale-95 transition-transform flex items-center justify-center gap-2">
                                <i className="fa-solid fa-download"></i> å‚™ä»½è³‡æ–™ (åŒ¯å‡º)
                            </button>
                            <button onClick={triggerRestore} className="w-full bg-base-100 text-base-600 py-3 rounded-xl font-bold active:scale-95 transition-transform flex items-center justify-center gap-2">
                                <i className="fa-solid fa-upload"></i> é‚„åŸè³‡æ–™ (åŒ¯å…¥)
                            </button>
                            <input type="file" id="restoreInput" className="hidden" accept=".json" onChange={handleRestoreFile} />
                            <p className="text-[10px] text-base-400 mt-2 text-center">å»ºè­°æ¯æœˆå‚™ä»½ä¸€æ¬¡ï¼Œæª”æ¡ˆå¯å­˜æ–¼æ‰‹æ©Ÿæˆ–é›²ç«¯ã€‚</p>
                        </div>

                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-base-100">
                            <h3 className="font-bold text-base-800 mb-4">å±éšªå€åŸŸ</h3>
                            <button onClick={onReset} className="w-full border border-rose-200 text-rose-500 py-3 rounded-xl font-bold active:scale-95 transition-transform">
                                æ¸…é™¤æ‰€æœ‰è³‡æ–™
                            </button>
                        </div>
                        
                        <div className="text-center text-xs text-base-300 mt-8">CashFlow Sense v3.3<br/>Designed for Pain & Awareness</div>
                    </div>
                </PageContainer>
            );
        };

        // --- Shared Item ---
        const TxItem = ({ tx, onDelete }) => {
            const m = METHODS[tx.method] || METHODS.cash; const isExp = tx.type === 'expense';
            return (
                <div className="flex justify-between items-center py-3 border-b border-base-200 last:border-0 animate-fade-in group">
                    <div className="flex items-center gap-3">
                        <div className={`w-9 h-9 rounded-full flex items-center justify-center text-sm ${isExp ? m.bg + ' ' + m.color : 'bg-emerald-50 text-emerald-600'}`}><i className={`fa-solid ${isExp ? m.icon : 'fa-arrow-down'}`}></i></div>
                        <div><div className="text-sm font-bold text-base-800">{tx.category}</div>
                        {tx.note && <div className="text-[10px] text-base-400 truncate max-w-[150px]">{tx.note}</div>}
                        </div>
                    </div>
                    <div className="flex items-center gap-3">
                        <div className={`text-base font-bold font-num ${isExp ? 'text-base-800' : 'text-emerald-600'}`}>{isExp ? '-' : '+'}{formatMoney(tx.amount)}</div>
                        {onDelete && <button onClick={(e) => {e.stopPropagation(); if(confirm('åˆªé™¤?')) onDelete(tx.id)}} className="text-base-200 hover:text-rose-500 px-1"><i className="fa-solid fa-xmark text-xs"></i></button>}
                    </div>
                </div>
            );
        };

        // --- Add Modal (v3.3 Expanded Cats) ---
        const AddModal = ({ mode, onClose, onSave }) => {
            const [amount, setAmount] = useState(''); const [method, setMethod] = useState(mode === 'income' ? 'cash' : ''); const [cat, setCat] = useState(''); const [note, setNote] = useState('');
            const cats = mode === 'income' ? CATS_INCOME : CATS_EXPENSE;
            const submit = () => {
                if(!amount) return; if(mode==='expense' && !method) return;
                onSave({ id: Date.now(), date: getToday(), amount: parseFloat(amount), type: mode, method: mode==='income'?'cash':method, category: cat||'å…¶ä»–', note });
                onClose();
            };
            return (
                <div className="fixed inset-0 z-[100] flex flex-col justify-end">
                    <div className="absolute inset-0 bg-base-900/30 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white rounded-t-3xl p-6 w-full animate-slide-up relative z-10 safe-bottom shadow-2xl h-[90vh] flex flex-col">
                        <div className="flex justify-between mb-4"><span className="text-lg font-bold text-base-800">{mode==='income'?'é€²å¸³':'æ”¯å‡º'}</span><button onClick={onClose}><i className="fa-solid fa-xmark text-base-400 text-xl"></i></button></div>
                        <div className="flex justify-center mb-6 relative"><span className="text-2xl text-base-300 absolute left-8 top-2">$</span><input autoFocus type="number" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="0" className="text-5xl font-bold text-center w-full outline-none font-num text-base-800 bg-transparent placeholder-base-100"/></div>
                        
                        <div className="flex-1 overflow-y-auto no-scrollbar">
                            {mode === 'expense' && <div className="mb-6"><div className="text-xs font-bold text-base-300 uppercase tracking-widest text-center mb-3">Payment</div><div className="flex justify-center gap-3">{['cash','mobile','card'].map(k => (<button key={k} onClick={() => setMethod(k)} className={`w-16 h-16 rounded-2xl flex flex-col items-center justify-center gap-1 border-2 transition-all ${method===k ? 'border-base-800 bg-base-50 text-base-800' : 'border-base-100 text-base-300'}`}><i className={`fa-solid ${METHODS[k].icon} text-lg`}></i><span className="text-[10px] font-bold">{METHODS[k].label}</span></button>))}</div></div>}
                            <div className="mb-6"><div className="text-xs font-bold text-base-300 uppercase tracking-widest text-center mb-3">Category</div><div className="flex flex-wrap justify-center gap-2">{cats.map(c => (<button key={c} onClick={() => setCat(c)} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${cat===c ? 'bg-base-800 text-white' : 'bg-base-100 text-base-400'}`}>{c}</button>))}</div></div>
                            <div className="mb-6 px-4"><input value={note} onChange={e=>setNote(e.target.value)} placeholder="å‚™è¨» (é¸å¡«)..." className="w-full bg-base-50 p-3 rounded-xl outline-none text-sm text-base-700"/></div>
                        </div>
                        
                        <button onClick={submit} className={`w-full py-4 rounded-xl text-white font-bold text-lg active:scale-95 transition-transform mt-4 ${mode==='income'?'bg-emerald-500':'bg-base-800'}`}>ç¢ºèª</button>
                    </div>
                </div>
            );
        };

        // Murmur Modal
        const MemoModal = ({ notes, onClose, onSave, onDelete }) => {
            const [text, setText] = useState(''); const [listening, setListening] = useState(false); const recognitionRef = useRef(null); const listRef = useRef(null);
            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition(); recognitionRef.current.continuous = false; recognitionRef.current.lang = 'zh-TW'; recognitionRef.current.interimResults = false;
                    recognitionRef.current.onresult = (event) => { setText(prev => prev + event.results[0][0].transcript); setListening(false); };
                    recognitionRef.current.onerror = () => setListening(false); recognitionRef.current.onend = () => setListening(false);
                }
            }, []);
            const toggleListen = () => { if(!recognitionRef.current) { alert('ä¸æ”¯æ´èªéŸ³'); return; } if(listening) { recognitionRef.current.stop(); setListening(false); } else { recognitionRef.current.start(); setListening(true); } };
            const save = () => { if(text) { onSave(text); setText(''); if(listRef.current) listRef.current.scrollTop = 0; } };
            return (
                <div className="fixed inset-0 z-[100] flex flex-col justify-end">
                    <div className="absolute inset-0 bg-base-900/30 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white rounded-t-3xl p-6 w-full animate-slide-up relative z-10 safe-bottom h-[85vh] flex flex-col shadow-2xl">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-base-800">éš¨è¨˜ Memo</h3><button onClick={onClose}><i className="fa-solid fa-xmark text-base-400"></i></button></div>
                        <div className="flex-none mb-4"><textarea value={text} onChange={e=>setText(e.target.value)} placeholder="å¯«ä¸‹ç•¶ä¸‹çš„æƒ³æ³•..." className="w-full h-24 p-4 bg-base-50 rounded-xl outline-none resize-none mb-3 text-base-800 border border-base-200 shadow-inner"></textarea><div className="flex gap-3"><button onClick={toggleListen} className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${listening ? 'bg-rose-500 text-white animate-pulse' : 'bg-base-100 text-base-500'}`}><i className={`fa-solid ${listening ? 'fa-stop' : 'fa-microphone'}`}></i></button><button onClick={save} className="flex-1 bg-base-800 text-white rounded-xl font-bold shadow-lg active:scale-95 transition-transform">ç´€éŒ„</button></div></div>
                        <div className="flex-1 overflow-y-auto no-scrollbar border-t border-base-100 pt-4" ref={listRef}><div className="text-xs font-bold text-base-400 mb-3 px-1">æ­·å²ç´€éŒ„</div>{notes.length === 0 ? <div className="text-center text-xs text-base-300 py-10">å°šç„¡ç´€éŒ„</div> : <div className="space-y-3">{notes.map(n => (<div key={n.id} className="bg-base-50 p-4 rounded-xl text-sm text-base-700 border border-base-100 shadow-sm flex justify-between group animate-fade-in"><div><div className="text-[10px] text-base-400 mb-1 font-bold">{n.date}</div><div className="leading-relaxed">{n.text}</div></div><button onClick={()=>onDelete(n.id)} className="text-base-300 hover:text-rose-500 self-start px-2"><i className="fa-solid fa-trash text-xs"></i></button></div>))}</div>}</div>
                    </div>
                </div>
            );
        };

        // --- App Root ---
        const App = () => {
            const [page, setPage] = useState('home'); 
            const [txs, setTxs] = useState([]);
            const [notes, setNotes] = useState([]);
            const [addMode, setAddMode] = useState(null);
            const [memoOpen, setMemoOpen] = useState(false);

            useEffect(() => { 
                const d = localStorage.getItem(DB_KEY); if(d) setTxs(JSON.parse(d)); 
                const n = localStorage.getItem(NOTE_KEY); if(n) setNotes(JSON.parse(n));
            }, []);
            
            const saveTx = (t) => { const n = [t,...txs]; setTxs(n); localStorage.setItem(DB_KEY, JSON.stringify(n)); };
            const delTx = (id) => { const n = txs.filter(t=>t.id!==id); setTxs(n); localStorage.setItem(DB_KEY, JSON.stringify(n)); };
            const saveNote = (txt) => { const n = [{id:Date.now(), text:txt, date:getToday()}, ...notes]; setNotes(n); localStorage.setItem(NOTE_KEY, JSON.stringify(n)); };
            const delNote = (id) => { const n = notes.filter(note=>note.id!==id); setNotes(n); localStorage.setItem(NOTE_KEY, JSON.stringify(n)); };
            
            const restoreData = (data) => {
                setTxs(data.transactions || []); localStorage.setItem(DB_KEY, JSON.stringify(data.transactions || []));
                setNotes(data.notes || []); localStorage.setItem(NOTE_KEY, JSON.stringify(data.notes || []));
                setPage('home');
            };
            const resetData = () => {
                if(confirm('è­¦å‘Šï¼šç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
                    setTxs([]); setNotes([]); localStorage.removeItem(DB_KEY); localStorage.removeItem(NOTE_KEY);
                    setPage('home'); alert('è³‡æ–™å·²æ¸…é™¤');
                }
            };

            return (
                <div className="h-full w-full bg-base-50 text-base-800">
                    {page === 'home' && <HomeLobby onNavigate={setPage} onOpenMemo={()=>setMemoOpen(true)} noteCount={notes.length} onOpenSettings={()=>setPage('settings')} />}
                    {page === 'journal' && <JournalPage transactions={txs} onBack={()=>setPage('home')} onOpenAdd={setAddMode} onDelete={delTx} />}
                    {page === 'insight' && <InsightPage transactions={txs} onBack={()=>setPage('home')} />}
                    {page === 'calendar' && <RecordPage transactions={txs} onBack={()=>setPage('home')} />}
                    {page === 'vault' && <VaultPage transactions={txs} onBack={()=>setPage('home')} />}
                    {page === 'settings' && <SettingsPage onBack={()=>setPage('home')} transactions={txs} notes={notes} onRestore={restoreData} onReset={resetData} />}
                    
                    {addMode && <AddModal mode={addMode} onClose={()=>setAddMode(null)} onSave={saveTx} />}
                    {memoOpen && <MemoModal notes={notes} onClose={()=>setMemoOpen(false)} onSave={saveNote} onDelete={delNote} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js'); }); }
    </script>
</body>
</html>